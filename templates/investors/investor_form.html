{% extends 'investors/base.html' %}

{% block title %}{% if object %}Edit{% else %}Add{% endif %} Investor - Investor Platform{% endblock %}

{% block page_title %}Investors{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h4 class="mb-0">
                        <i class="bi bi-person-plus"></i> {% if object %}Edit{% else %}Add New{% endif %} Investor
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <h5 class="text-primary mb-3">Personal Information</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">{{ form.full_name.label }} <span class="text-danger">*</span></label>
                                {{ form.full_name }}
                                {% if form.full_name.errors %}<div class="text-danger small">{{ form.full_name.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ form.email.label }} <span class="text-danger">*</span></label>
                                {{ form.email }}
                                {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ form.mobile.label }} <span class="text-danger">*</span></label>
                                {{ form.mobile }}
                                {% if form.mobile.errors %}<div class="text-danger small">{{ form.mobile.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ form.dob.label }} <span class="text-danger">*</span></label>
                                {{ form.dob }}
                                {% if form.dob.errors %}<div class="text-danger small">{{ form.dob.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ form.profession.label }}</label>
                                {{ form.profession }}
                                {% if form.profession.errors %}<div class="text-danger small">{{ form.profession.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">{{ form.address.label }} <span class="text-danger">*</span></label>
                                {{ form.address }}
                                {% if form.address.errors %}<div class="text-danger small">{{ form.address.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">{{ form.family_head.label }}</label>
                                {{ form.family_head }}
                                <small class="text-muted">Link to Primary Investor if applicable</small>
                            </div>                            
                            <div class="col-md-12">
                                <label class="form-label">{{ form.remark.label }}</label>
                                {{ form.remark }}
                            </div>
                        </div>

                        <hr class="my-4">

                        <h5 class="text-primary mb-3">KYC Information</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.pan.label }}</label>
                                {{ form.pan }}
                                {% if form.pan.errors %}<div class="text-danger small">{{ form.pan.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.aadhaar.label }}</label>
                                {{ form.aadhaar }}
                                {% if form.aadhaar.errors %}<div class="text-danger small">{{ form.aadhaar.errors }}</div>{% endif %}
                            </div>
                        </div>

                        <hr class="my-4">

                        <h5 class="text-primary mb-3">Investment Philosophy</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.risk_appetite.label }}</label>
                                {{ form.risk_appetite }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.preferred_duration.label }}</label>
                                {{ form.preferred_duration }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.ticket_size_preference.label }}</label>
                                {{ form.ticket_size_preference }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.preferred_industries.label }}</label>
                                <small class="text-muted d-block mb-2">Drag to reorder by priority (Top = Highest Priority)</small>
                                
                                <!-- Hidden input to store the ordered list -->
                                {{ form.preferred_industries }}
                                
                                <!-- Draggable list container -->
                                <div id="industries-sortable-list" class="list-group" data-initial-value="{{ form.preferred_industries.value|default:'[]' }}">
                                    <!-- Items will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h5 class="text-primary mb-3">Bank & Demat Details</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">{{ form.bank_name.label }}</label>
                                {{ form.bank_name }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ form.account_number.label }}</label>
                                {{ form.account_number }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ form.ifsc_code.label }}</label>
                                {{ form.ifsc_code }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.dp_id.label }}</label>
                                {{ form.dp_id }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ form.client_id.label }}</label>
                                {{ form.client_id }}
                            </div>
                        </div>

                        <hr class="my-4">

                        <h5 class="text-primary mb-3">Grouping & Assignment</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.referred_by.label }}</label>
                                {{ form.referred_by }}
                                <div id="referred-by-other-container" style="display: none;">
                                    {{ form.referred_by_other }}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">{{ form.assigned_team_members.label }}</label>
                                {% if form.assigned_team_members.disabled %}
                                    <!-- For team members: Hide the field completely, just show auto-assignment info -->
                                    <div class="alert alert-info p-2">
                                        <small><strong>ℹ️ Auto-Assigned:</strong> You are automatically assigned to manage this investor.</small>
                                    </div>
                                {% else %}
                                    <!-- For partners/admins: Show the select field -->
                                    {{ form.assigned_team_members }}
                                    {% if form.assigned_team_members.errors %}<div class="text-danger small">{{ form.assigned_team_members.errors }}</div>{% endif %}
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Total Investment capacity defined by Beeline</label>
                                {{ form.group }}
                                <small class="text-muted">Auto-assigns Group As per investment_capacity</small>
                            </div>
                            
                            {% if user.is_partner or user.is_admin %}
                            <div class="col-md-12 mt-3 p-3 bg-light rounded border">
                                <div class="form-check form-switch">
                                    {{ form.is_active }}
                                    <label class="form-check-label fw-bold" for="{{ form.is_active.id_for_label }}">Active Status (Partner Approval)</label>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="mt-4 d-flex justify-content-between">
                            <a href="{% url 'investors:investor_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-check-circle"></i> Save Investor
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Ensure Bootstrap formatting is applied
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.type !== 'checkbox' && !input.classList.contains('form-control') && !input.classList.contains('form-select')) {
                if (input.tagName === 'SELECT') {
                    input.classList.add('form-select');
                } else if (input.tagName === 'TEXTAREA') {
                    input.classList.add('form-control');
                } else {
                    input.classList.add('form-control');
                }
            }
            if (input.type === 'checkbox') {
                input.classList.add('form-check-input');
            }
        });
        
        // Initialize Preferred Industries Drag-and-Drop
        initializeIndustriesSortable();

        // Initialize Referred By Other UI Logic
        const referralSelect = document.getElementById('id_referred_by');
        const referralOtherContainer = document.getElementById('referred-by-other-container');
        const referralOtherInput = document.getElementById('id_referred_by_other');

        function toggleReferralOther() {
            if (referralSelect && referralSelect.value === 'other') {
                referralOtherContainer.style.display = 'block';
                referralOtherInput.required = true;
            } else if (referralSelect) {
                referralOtherContainer.style.display = 'none';
                referralOtherInput.required = false;
            }
        }

        if (referralSelect && referralOtherContainer) {
            referralSelect.addEventListener('change', toggleReferralOther);
            toggleReferralOther(); // Run on init
        }
    });
    
    function initializeIndustriesSortable() {
        const hiddenInput = document.getElementById('id_preferred_industries');
        const sortableList = document.getElementById('industries-sortable-list');
        
        if (!hiddenInput || !sortableList) return;
        
        // All available industries in default order (from model)
        const allIndustries = [
            'Technology',
            'Healthcare',
            'Finance',
            'Real Estate',
            'Consumer Goods',
            'Energy',
            'Others'
        ];
        
        // Get current order from data attribute (set by Django template)
        let currentOrder = [];
        try {
            // Read from data attribute instead of hidden input value for reliability
            const initialValue = sortableList.dataset.initialValue;
            
            if (initialValue && initialValue !== '[]' && initialValue !== 'None') {
                // Determine if the value is wrapped in quotes (stringified JSON)
                // or if it needs parsing
                if (typeof initialValue === 'string') {
                     // Sometimes Django template renders with surrounding quotes
                     // We need to parse strict JSON
                     currentOrder = JSON.parse(initialValue);
                }
            }
        } catch (e) {
            console.error('Error parsing preferred industries:', e);
        }
        
        // If no current order, use default order
        if (currentOrder.length === 0) {
            currentOrder = [...allIndustries];
        }
        
        // Populate the sortable list
        sortableList.innerHTML = '';
        currentOrder.forEach((industry) => {
            const item = createIndustryItem(industry);
            sortableList.appendChild(item);
        });
        
        // Initialize SortableJS
        const sortable = Sortable.create(sortableList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            handle: '.drag-handle',
            onEnd: function() {
                updateHiddenInput();
            }
        });
        
        // Function to create an industry list item
        function createIndustryItem(industry) {
            const div = document.createElement('div');
            div.className = 'list-group-item d-flex align-items-center';
            div.style.cursor = 'move';
            div.dataset.industry = industry;
            
            div.innerHTML = `
                <span class="drag-handle me-3" style="cursor: grab;">
                    <i class="bi bi-grip-vertical fs-5"></i>
                </span>
                <span class="flex-grow-1">${industry}</span>
            `;
            
            return div;
        }
        
        // Function to update hidden input with current order
        function updateHiddenInput() {
            const items = sortableList.querySelectorAll('.list-group-item');
            const orderedIndustries = [];
            
            items.forEach((item) => {
                const industry = item.dataset.industry;
                orderedIndustries.push(industry);
            });
            
            // Update hidden input
            hiddenInput.value = JSON.stringify(orderedIndustries);
        }
        
        // Initial update of hidden input
        updateHiddenInput();
    }
</script>

<style>
    /* Sortable.js visual feedback styles */
    .sortable-ghost {
        opacity: 0.4;
        background-color: #f8f9fa;
    }
    
    .sortable-chosen {
        background-color: #e7f3ff;
        border-color: #0d6efd;
    }
    
    .sortable-drag {
        opacity: 0.8;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .drag-handle:active {
        cursor: grabbing !important;
    }
    
    #industries-sortable-list .list-group-item {
        transition: all 0.2s ease;
    }
    
    #industries-sortable-list .list-group-item:hover {
        background-color: #f8f9fa;
        border-color: #0d6efd;
    }
    
    /* Checkbox styling for team members */
    #id_assigned_team_members {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    #id_assigned_team_members .form-check {
        margin-bottom: 0;
    }
</style>
{% endblock %}